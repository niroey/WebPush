<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="SmartBroker">
  <link rel="apple-touch-icon" href="/icon.png">
  <meta charset="UTF-8">
  <title>웹푸시 구독</title>
</head>
<body>
  <h2>웹푸시 구독</h2>
  <button id="subscribeBtn">웹푸시 구독</button>

  <script>
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = window.atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }

    document.getElementById("subscribeBtn").addEventListener("click", async () => {
      if (!("serviceWorker" in navigator)) {
        alert("Service Worker 지원 안됨");
        return;
      }

      try {
        // SW 등록
        const reg = await navigator.serviceWorker.register("/sw.js");
        await navigator.serviceWorker.ready;

         // 서버에서 공개 키 가져오기
        const res = await fetch("/vapidPublicKey");
        const { publicKey } = await res.json();

         // 기존 구독 확인
        let subscription = await reg.pushManager.getSubscription();
        if (!subscription) {
          // 없으면 새 구독 생성
          subscription = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey)
          });
        }

        // 서버 전송
        await fetch("/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(subscription)
        });

        alert("웹푸시 구독 완료!");
      } catch (err) {
        console.error(err);
        alert("구독 실패: " + err.message);
      }
    });
  </script>
</body>
</html>
